{% assign raw_path = include.path | default: include.href | default: include.src | default: '' %}
{% assign path = raw_path | strip %}
{% if path == '' %}
{% elsif path contains '://' %}
  {{ path | strip }}
{% elsif path | slice: 0, 1 == '#' %}
  {{ path }}
{% else %}
  {% assign normalized = path %}
  {% if normalized | slice: 0, 1 == '/' %}
    {% assign normalized = normalized | remove_first: '/' %}
  {% endif %}

  {% case include.scope %}
  {% when 'asset' %}
    {% assign root = site.asset_root %}
  {% when 'link' %}
    {% assign root = site.link_root %}
  {% else %}
    {% assign root = include.base %}
  {% endcase %}

  {% assign root = root | default: '' | strip %}
  {% if root == '' %}
    {% assign root = site.baseurl | default: '' | strip %}
  {% endif %}

  {% assign github = site.github %}
  {% if root == '' and github %}
    {% assign github_base = github.baseurl | default: '' | strip %}
    {% assign repo_slug = nil %}
    {% if github.is_project_page %}
      {% assign repo_slug = github.repository_name %}
      {% if repo_slug == '' or repo_slug == nil %}
        {% assign repo_nwo = github.repository_nwo | default: site.repository %}
        {% if repo_nwo and repo_nwo != '' %}
          {% assign repo_slug = repo_nwo | split: '/' | last %}
        {% endif %}
      {% endif %}
    {% endif %}

    {% assign use_github_base = github_base != '' %}
    {% if use_github_base and repo_slug and repo_slug != '' and github_base contains '/pages/' %}
      {% assign use_github_base = false %}
    {% endif %}

    {% if use_github_base %}
      {% assign root = github_base %}
    {% elsif repo_slug and repo_slug != '' %}
      {% capture project_root %}/{{ repo_slug }}{% endcapture %}
      {% assign root = project_root | strip %}
    {% endif %}

    {% if root == '' %}
      {% assign root = github.url | default: '' | strip %}
    {% endif %}
  {% endif %}

  {% if root contains '://' %}
    {% assign trailing = root | slice: -1, 1 %}
    {% if trailing == '/' %}
      {{ root | append: normalized | strip }}
    {% else %}
      {{ root | append: '/' | append: normalized | strip }}
    {% endif %}
  {% elsif root != '' %}
    {% assign prefix = root %}
    {% if prefix | slice: 0, 1 != '/' %}
      {% assign prefix = '/' | append: prefix %}
    {% endif %}
    {% assign trailing = prefix | slice: -1, 1 %}
    {% if trailing == '/' %}
      {{ prefix | append: normalized | strip }}
    {% else %}
      {{ prefix | append: '/' | append: normalized | strip }}
    {% endif %}
  {% else %}
    {{ '/' | append: normalized | relative_url | strip }}
  {% endif %}
{% endif %}
